<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>3-Sides ‚Äî LOGIN</title>
  <meta name="description" content="Login to the Three Sides wellness planner." />

  <!-- Service worker -->
  <script src="sw-register.js"></script>

  <!-- Firebase boot -->
  <script type="module">
    import './firebase-init.js';
  </script>

  <!-- Global session bump listener -->
  <script type="module">
    import { auth, db } from './firebase-init.js';
    import { onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
    import { doc, onSnapshot } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

    const LOCAL_MARK = 'gs_session_ack_ts';
    onAuthStateChanged(auth, (user) => {
      if (!user) return;
      const uref = doc(db, 'users', user.uid);
      onSnapshot(uref, async (snap) => {
        const bump = snap?.data()?.sessionBumpedAt?.toMillis?.() || 0;
        const seen = parseInt(localStorage.getItem(LOCAL_MARK) || '0', 10);
        if (bump > seen) {
          localStorage.setItem(LOCAL_MARK, String(bump));
          try { await signOut(auth); } finally { location.replace('login.html'); }
        }
      });
    });
  </script>

  <!-- prefs bootstrap -->
  <script>
    (function () {
      const PREFS_KEY = 'gs_prefs';
      let p = {};
      try { p = JSON.parse(localStorage.getItem(PREFS_KEY) || '{}'); } catch { }
      document.documentElement.style.setProperty('--motion-scale', p.reducedMotion ? '0' : '1');
      document.documentElement.style.setProperty('--text-size', p.largerText ? '1.1rem' : '1rem');
    })();
  </script>

  <!-- PWA manifest + icons -->
  <link rel="manifest" href="manifest.webmanifest" />
  <link rel="icon" type="image/svg+xml" sizes="any" href="/3-sides-planner.io/favicon.svg" />
  <link rel="icon" type="image/png" sizes="32x32" href="/3-sides-planner.io/favicon-32.png" />
  <link rel="icon" type="image/png" sizes="16x16" href="/3-sides-planner.io/favicon-16.png" />
  <link rel="apple-touch-icon" href="/3-sides-planner.io/icon-192.png" />

  <style>
    :root {
      --page-bg: #c7f5f2;
      --page-bg-2: #a7e7dd;
      --card-bg: #ffffff;
      --accent: #ff6fa9;
      --accent-soft: #ffe3f2;
      --text-main: #134e4a;
      --text-muted: #4b5563;
      --radius-lg: 24px;
      --shadow-soft: 0 16px 40px rgba(15, 23, 42, 0.22);
      --max-width: 430px;
    }
  
    *,
    *::before,
    *::after {
      box-sizing: border-box;
    }
  
    /* NEW: lock horizontal width */
    html,
    body {
      margin: 0;
      padding: 0;
      max-width: 100%;
      overflow-x: hidden;
    }
  
    body {
      min-height: 100vh;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: radial-gradient(circle at top, #e5fbff 0, var(--page-bg) 50%, var(--page-bg-2) 100%);
      display: flex;
      justify-content: center;
      align-items: stretch;
      color: var(--text-main);
    }
  
    .shell {
      width: 100%;
      max-width: var(--max-width);
      padding: 20px 16px;
      display: flex;
      align-items: center;
      justify-content: center;
    }
  
    .auth-card {
      width: 100%;
      background: var(--card-bg);
      border-radius: var(--radius-lg);
      box-shadow: var(--shadow-soft);
      padding: 22px 18px 16px;
      display: flex;
      flex-direction: column;
    }
  
    .auth-header {
      text-align: center;
      margin-bottom: 14px;
    }
  
    .auth-title {
      margin: 0;
      font-size: 1.7rem;
      color: black;
    }
  
    .auth-sub {
      margin: 4px 0 0;
      font-size: 0.9rem;
      color: var(--text-muted);
    }
  
    .login-container {
      max-width: 360px;
      width: 100%;
      margin: 0 auto;
    }
  
    form {
      margin: 14px 0 6px;
    }
  
    .auth-group {
      margin-bottom: 0.75rem;
      text-align: left;
    }
  
    .auth-label {
      display: block;
      font-size: 0.85rem;
      margin-bottom: 4px;
      color: var(--text-main);
    }
  
    .auth-input {
      width: 100%;
      height: 44px;
      padding: 10px 12px;
      border-radius: 999px;
      border: 1px solid #cbd5e1;
      font-size: 0.95rem;
      outline: none;
    }
  
    .auth-input::placeholder {
      color: rgba(0, 0, 0, 0.45);
      font-weight: 500;
    }
  
    .auth-input:focus {
      border-color: var(--accent);
      box-shadow: 0 0 0 3px rgba(255, 111, 169, 0.28);
    }
  
    .password-row {
      display: flex;
      align-items: center;
      gap: 8px;
    }
  
    .password-row .auth-input {
      flex: 1 1 auto;
    }
  
    .toggle-pass {
      border-radius: 999px;
      border: 1px solid #cbd5e1;
      background: var(--accent-soft);
      color: #4b5563;
      padding: 8px 11px;
      font-size: 0.8rem;
      cursor: pointer;
      min-width: 64px;
      line-height: 1;
      white-space: nowrap;
    }
  
    .toggle-pass:active {
      transform: translateY(1px);
    }
  
    .auth-button {
      width: 100%;
      border: none;
      border-radius: 999px;
      padding: 11px 14px;
      margin-top: 6px;
      font-size: 1rem;
      font-weight: 600;
      background: var(--accent);
      color: #ffffff;
      cursor: pointer;
      transition: transform 0.08s ease, box-shadow 0.08s ease, background 0.15s ease;
      box-shadow: 0 10px 22px rgba(244, 114, 182, 0.45);
    }
  
    .auth-button:active {
      transform: translateY(1px);
      box-shadow: 0 5px 12px rgba(244, 114, 182, 0.35);
    }
  
    #msg {
      margin: 0.6rem 0 0;
      padding: 0.55rem 0.7rem;
      border-radius: 12px;
      font-size: 0.85rem;
      text-align: left;
    }
  
    #msg:empty {
      margin: 0.25rem 0 0;
      padding: 0;
      border: none;
    }
  
    .msg-error {
      background: #fee2e2;
      color: #b91c1c;
      border: 1px solid #fecaca;
    }
  
    .msg-ok {
      background: #ecfeff;
      color: #155e75;
      border: 1px solid #a5f3fc;
    }
  
    .auth-links {
      margin-top: 0.9rem;
      font-size: 0.9rem;
      color: var(--text-muted);
      text-align: center;
    }
  
    .auth-links a {
      color: #9097de;
      font-weight: 700;
      text-decoration: none;
    }
  
    .auth-links a:hover,
    .auth-links a:focus {
      color: #d39cff;
      text-decoration: underline;
    }
  
    .forgot-row {
      margin-top: 0.45rem;
      font-size: 0.85rem;
      text-align: center;
    }
  
    .forgot-row a {
      color: #007bff;
      text-decoration: underline;
    }
  
    .card-footer {
      margin-top: 16px;
      padding-top: 12px;
      border-top: 1px solid #e5e7eb;
      text-align: center;
      font-size: 0.8rem;
      color: #9ca3af;
    }
  
    .backToApp {
      display: inline-block;
      margin-bottom: 4px;
      font-size: 0.9rem;
      color: rgb(201, 108, 201);
      text-decoration: none;
    }
  
    .backToApp:hover,
    .backToApp:focus {
      text-decoration: underline;
    }
  
    .legal-footer {
      font-size: 0.8rem;
    }
  
    .legal-footer a {
      color: #9097de;
      text-decoration: underline;
    }
  
    @media (max-width: 600px) {
      .shell {
        padding: 16px 12px;
      }
  
      .auth-card {
        border-radius: 20px;
      }
    }
  </style>
  
</head>

<body>
  <div class="shell">
    <div class="auth-card">
      <div class="auth-header">
        <h1 class="auth-title">Login</h1>
        <p class="auth-sub">Sign in to continue your Three Sides planner.</p>
      </div>

      <div class="login-container">
        <form id="loginForm" novalidate>
          <div class="auth-group">
            <label class="auth-label" for="email">Email</label>
            <input id="email" type="email" class="auth-input" placeholder="Email (required)" autocomplete="username"
              inputmode="email" required />
          </div>

          <div class="auth-group">
            <label class="auth-label" for="pass">Password</label>
            <div class="password-row">
              <input id="pass" type="password" class="auth-input" placeholder="Password (required)"
                autocomplete="current-password" required />
              <button type="button" id="togglePass" class="toggle-pass" aria-pressed="false" aria-label="Show password">
                Show
              </button>
            </div>
          </div>

          <button id="loginBtn" type="submit" class="auth-button">Log in</button>
        </form>

        <div id="msg" aria-live="polite"></div>

        <p class="auth-links">
          Need to create an account?
          <a href="register.html">Register here</a>
        </p>

        <p class="forgot-row">
          <a href="#" id="forgotPassword">Forgot Password?</a>
        </p>
      </div>

      <div class="card-footer">
        <a href="index.html" class="backToApp">‚Üê Back to App</a>
        <div class="legal-footer">
          View our
          <a href="privacy.html" rel="noopener">Privacy Policy</a>
          and
          <a href="terms.html" rel="noopener">Terms of Use</a>.
        </div>
      </div>
    </div>
  </div>

  <!-- keep submit tying into loginBtn -->
  <script>
    document.getElementById('loginForm')?.addEventListener('submit', function (e) {
      e.preventDefault();
      document.getElementById('loginBtn')?.click();
    });

    // show / hide password
    (function () {
      const passInput = document.getElementById('pass');
      const toggleBtn = document.getElementById('togglePass');
      if (!passInput || !toggleBtn) return;

      toggleBtn.addEventListener('click', () => {
        const isHidden = passInput.type === 'password';
        passInput.type = isHidden ? 'text' : 'password';
        toggleBtn.textContent = isHidden ? 'Hide' : 'Show';
        toggleBtn.setAttribute('aria-pressed', String(isHidden));
        passInput.focus();
      });
    })();
  </script>

  <!-- ================= Firebase login logic ================= -->
  <script type="module">
    import { auth, db } from "./firebase-init.js";
    import {
      onAuthStateChanged,
      signInWithEmailAndPassword,
      GoogleAuthProvider,
      signInWithPopup,
      getRedirectResult,
      sendPasswordResetEmail
    } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
    import {
      doc, getDoc, setDoc, updateDoc,
      serverTimestamp, arrayUnion
    } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

    const log = (...a) => console.log("[login]", ...a);

    function goNext() {
      const qsNext = new URLSearchParams(location.search).get("next");
      const next = qsNext || "index.html";
      log("redirect ‚Üí", next);
      location.replace(next);
    }

    // keep ?next on Register link
    (function wireLinks() {
      const next = new URLSearchParams(location.search).get("next");
      const regLink = document.querySelector(".auth-links a");
      if (regLink) regLink.href = `register.html${next ? `?next=${encodeURIComponent(next)}` : ""}`;
    })();

    const emailEl = document.getElementById("email");
    const passEl = document.getElementById("pass");
    const btn = document.getElementById("loginBtn");
    const msg = document.getElementById("msg");

    const setMsg = (t, kind) => {
      if (!msg) return;
      msg.textContent = t || "";
      msg.classList.remove("msg-error", "msg-ok");
      if (kind) msg.classList.add(kind);
    };

    [emailEl, passEl].forEach(el => el?.addEventListener("keydown", e => {
      if (e.key === "Enter") btn?.click();
    }));

    async function awardLoginBadge(uid) {
      const userRef = doc(db, "users", uid);
      await setDoc(userRef, { createdAt: serverTimestamp() }, { merge: true });

      await updateDoc(userRef, { badges: arrayUnion("login") }).catch(async (err) => {
        log("arrayUnion fell back (will merge set)", err?.code || err?.message);
        await setDoc(userRef, { badges: ["login"] }, { merge: true });
      });

      const badgeRef = doc(db, "users", uid, "badges", "login");
      const snap = await getDoc(badgeRef);
      if (!snap.exists()) {
        await setDoc(badgeRef, {
          key: "login",
          label: "First Login",
          emoji: "üîë",
          earnedAt: serverTimestamp()
        });
        log("created sub-badge doc");
      } else {
        log("sub-badge doc already existed");
      }
    }

    let awarding = false;
    async function ensureBadgeThenGo(user) {
      if (!user) return;
      if (awarding) return;
      awarding = true;
      try {
        log("awarding login badge for uid:", user.uid);
        await awardLoginBadge(user.uid);
        log("badge awarded");
      } catch (e) {
        console.error("[login] award error:", e);
      } finally {
        goNext();
      }
    }

    // email/password login
    btn?.addEventListener("click", async () => {
      try {
        setMsg("Signing in‚Ä¶");
        const email = (emailEl?.value || "").trim();
        const pass = passEl?.value || "";
        await signInWithEmailAndPassword(auth, email, pass);
        await ensureBadgeThenGo(auth.currentUser);
      } catch (err) {
        console.error(err);
        const code = err?.code || "";
        if (code === "auth/invalid-credential" || code === "auth/wrong-password") {
          setMsg("Incorrect email or password.", "msg-error");
        } else if (code === "auth/user-not-found") {
          setMsg("No account found with that email.", "msg-error");
        } else if (code === "auth/too-many-requests") {
          setMsg("Too many attempts. Please try again later.", "msg-error");
        } else {
          setMsg(err.message || "Sign-in failed.", "msg-error");
        }
      }
    });

    // optional Google button later
    const googleBtn = document.getElementById("googleSignIn");
    googleBtn?.addEventListener("click", async () => {
      setMsg("Signing in with Google‚Ä¶");
      try {
        await signInWithPopup(auth, new GoogleAuthProvider());
        await ensureBadgeThenGo(auth.currentUser);
      } catch (err) {
        console.error(err);
        setMsg(err.code || err.message, "msg-error");
      }
    });

    getRedirectResult(auth)
      .then(async (res) => { if (res?.user) await ensureBadgeThenGo(res.user); })
      .catch((err) => console.error(err));

    onAuthStateChanged(auth, async (u) => {
      if (u) {
        log("already signed in; ensuring badge");
        await ensureBadgeThenGo(u);
      }
    });

    // forgot password
    const forgotLink = document.getElementById("forgotPassword");
    forgotLink?.addEventListener("click", async (e) => {
      e.preventDefault();

      let email = (emailEl?.value || "").trim();
      if (!email) {
        email = prompt("Enter your registered email address:")?.trim() || "";
      }
      if (!email) {
        setMsg("Please enter your email address.", "msg-error");
        return;
      }

      try {
        setMsg("Sending reset link‚Ä¶");
        await sendPasswordResetEmail(auth, email);
        setMsg("‚úÖ Reset link sent! Check your inbox (and spam).", "msg-ok");
      } catch (error) {
        console.error("Password reset error:", error);
        if (error.code === "auth/user-not-found") {
          setMsg("No account found with that email address.", "msg-error");
        } else if (error.code === "auth/invalid-email") {
          setMsg("Invalid email format. Please try again.", "msg-error");
        } else if (error.code === "auth/too-many-requests") {
          setMsg("Too many attempts. Try again later.", "msg-error");
        } else {
          setMsg("Something went wrong. Please try again.", "msg-error");
        }
      }
    });
  </script>
</body>

</html>