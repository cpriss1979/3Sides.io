<!DOCTYPE html>
<html lang="en">

<head>
    <!-- Charset + viewport -->
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
    <title>Settings ‚Äî Three Sides</title>

    <!-- Your styles (kept) -->
    <style>
        :root {
            color-scheme: light dark;
        }

        body {
            margin: 0;
            font-family: ui-sans-serif, -apple-system, Segoe UI, Roboto, sans-serif;
            background: #f7f7fb;
        }

        header {
            position: sticky;
            top: 0;
            z-index: 10;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 16px;
            background: #fff;
            border-bottom: 1px solid #eee;
        }

        .brand {
            font-weight: 800;
            letter-spacing: .2px;
        }

        .muted {
            color: #666;
        }

        main {
            max-width: 880px;
            margin: 18px auto 40px;
            padding: 0 16px;
        }

        /* ================== container colors ==================== */
        .card {
            background: #fff;
            border: 1px solid #eee;
            border-radius: 6px;
            padding: 20px;
            margin: 14px 0;
            box-shadow: 0 10px 30px rgba(0, 0, 0, .05);
        }

        h1 {
            margin: 8px 0 12px;
            font-size: 2.4rem;
            color: black;
            text-align: center;
            text-decoration: underline;
        }

        h2 {
            margin: 0 0 8px;
            font-size: 1.2rem;
            color: rgb(72, 60, 60);
        }

        label {
            display: block;
            font-weight: 700;
            margin: 10px 0 6px;
        }

        input,
        button {
            font-size: 16px;
            padding: 12px;
            border-radius: 6px;
            border: 1px solid #ddd;
        }

        /* ================= password input fields =============== */
        input {
            width: 94%;
        }

        button {
            cursor: pointer;
        }

        .row {
            display: flex;
            gap: 10px;
            align-items: center;
            flex-wrap: wrap;
        }

        .btn {
            background: #111;
            color: #fff;
            border: 0;
            font-weight: 700;
        }

        .btn-ghost {
            background: #f1f1f1;
            color: #111;
            border: 1px solid #e5e5e5;
        }

        .status {
            margin-top: 8px;
            font-size: .95rem;
            color: #555;
        }

        /* ============= danger zone =============== */
        .danger {
            border: 1px solid #ffd2d2;
            background: #fff3f3;
        }

        .btn-danger {
            background: #d92d20;
            color: #fff;
            border: 0;
            font-weight: 700;
        }

        .two {
            display: grid;
            grid-template-columns: 1fr 260px;
            gap: 12px;
        }

        @media (max-width: 760px) {
            .two {
                grid-template-columns: 1fr;
            }
        }

        /* ================ user account email ================= */
        .email-blue {
            color: #0b5fff;
            word-break: break-all;
            font-weight: 700;
        }

        .backlink {
            text-decoration: underline;
            cursor: pointer;
            font-size: 18px;
            font-weight: bolder;
        }

        /* Make just the Account card tighter */
        .account-card {
            padding: 10px 12px;
        }

        /* Make the right column only as wide as the button */
        .account-card .two {
            grid-template-columns: 1fr auto;
            align-items: center;
        }

        /* Kill extra spacing around the logout row */
        .account-card .row {
            margin: 0;
            padding: 0;
        }

        /* Small, tidy logout button */
        #logoutBtn {
            padding: 6px 10px;
            font-size: 14px;
            border-radius: 6px;
        }

        /* Tighter Account card */
        .account-card {
            padding: 30px 32px;
        }

        /* Layout: left info + right button, nicely aligned */
        .acct-row {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 12px;
        }

        .acct-left {
            line-height: 1.15;
        }

        .acct-label {
            font-size: 12px;
            color: #666;
            margin-bottom: 2px;
        }

        .acct-email {
            font-size: 20px;
            font-weight: 800;
            color: #0b5fff;
            word-break: break-all;
            letter-spacing: 0.1px;
        }

        .acct-sub {
            margin-top: 4px;
            font-size: 12.5px;
            color: #666;
        }

        .acct-sub .sep {
            margin: 0 6px;
            opacity: .5;
        }

        #logoutBtn {
            padding: 8px 12px;
            font-size: 14px;
            border-radius: 6px;
            border: 2px solid #7d81897c;
            background: #d3d7de;
        }

        #copyUid {
            padding: 6px 10px;
            border: 1px solid #ddd;
            border-radius: 6px;
            background: #111;
            color: #fff;
            font-weight: 700;
            cursor: pointer;
        }

        #copyUid:hover {
            filter: brightness(.95);
        }

        #copyUid:active {
            transform: translateY(1px);
        }

        #copyUid.copied {
            background: #16a34a;
        }

        /* Tighten spacing under the Password title to the label */
        .account-card h2+label {
            margin-top: 2px;
            font-size: .95rem;
            color: #666;
        }

        #currentPw,
        #newPw {
            background-color: #e0e0e0;
            color: #111;
        }

        #currentPw2,
        #newPw2 {
            background-color: #e0e0e0;
            color: #111;
        }

        /* Stack the links in Preferences */
        .prefs a {
            display: block;
            margin: 6px 0;
        }

        :root {
            --brand: #0b5fff;
            --brand-d: #0848cc;
        }

        .btn-wide {
            display: block;
            width: 90%;
            padding: 12px 16px;
            border-radius: 6px;
            border: 0;
            background: var(--brand);
            color: #fff;
            font-weight: 700;
            text-align: center;
            box-shadow: 0 2px 8px rgba(11, 95, 255, .18);
            transition: filter .15s ease, transform .08s ease;
        }

        .btn-wide:hover {
            filter: brightness(.96)
        }

        .btn-wide:active {
            transform: translateY(1px)
        }

        .btn-wide+.btn-wide {
            margin-top: 10px;
        }

        /* === Normalize section headings === */
        .card h2 {
            font: 800 1.5rem/1.25 ui-sans-serif, -apple-system, "Segoe UI", Roboto, sans-serif;
            letter-spacing: .1px;
            margin: 0 0 10px;
        }

        .account-card h2,
        .danger h2 {
            font-size: inherit;
            line-height: inherit;
            font-weight: inherit;
        }

        .card>h2,
        .account-card>h2,
        .danger>h2 {
            font-size: 1.5rem !important;
            line-height: 1.25 !important;
            font-weight: 800 !important;
            margin: 0 0 10px !important;
        }

        button:disabled {
            opacity: .6;
            cursor: not-allowed;
        }

        /* ================ colors + spacing for pw status ================= */
        .pw-status {
            margin-top: 6px;
            font-size: .95rem;
        }

        .pw-status.is-error {
            color: #b00020;
        }

        .pw-status.is-ok {
            color: #15803d;
        }

        .pw-status.is-hint {
            color: #555;
        }

        /* --- scrolling sanity --- */
        html,
        body {
            min-height: 100%;
            height: auto;
            overflow-y: auto;
        }

        main {
            overflow: visible;
        }

        header {
            position: sticky;
            top: 0;
            z-index: 10;
        }

        [class*="container"],
        [class*="wrap"],
        main,
        .card {
            max-height: none;
        }

        .backToApp {
            display: inline-block;
            margin: 6rem auto 6;
            padding: 10px 20px;
            background-color: #000 !important;
            color: #fff !important;
            font-size: 1rem;
            font-weight: 600;
            border: 1px solid white;
            border-radius: 6px;
            text-decoration: none;
            cursor: pointer;
            box-shadow: 0 0 10px rgba(255, 255, 255, .2);
            transition: background-color .3s, transform .2s;
            text-align: center;
        }

        .backToApp:hover {
            background: #222 !important;
            transform: scale(1.03);
        }

        .backToApp:active {
            transform: scale(0.98);
        }

        /* ================= THEME SHOP (from theme.html, appearance kept) ================= */

        html,
        body {
            width: 100vw;
            overflow-x: hidden;
        }

        .theme-size {
            font-size: 1rem !important;
        }

        .theme-size h1 {
            font-size: 3.6rem !important;
            line-height: 1.2 !important;
            margin: 1rem 0 .5rem !important;
        }

        .theme-gallery {
            display: grid;
            grid-template-columns: repeat(2, minmax(140px, 1fr)) !important;
            gap: 22px !important;
            padding: 0 8px !important;
            width: 90% !important;
            box-sizing: border-box !important;
            margin: 0 auto;
        }

        @media (max-width:600px) {
            .theme-gallery {
                grid-template-columns: repeat(2, minmax(140px, 1fr)) !important;
            }
        }

        .theme-card {
            height: auto !important;
            padding: 22px !important;
            font-size: 1rem !important;
            line-height: 1.2 !important;
            border-radius: 12px !important;
            box-shadow: 0 2px 8px rgba(0, 0, 0, .12) !important;
            background: rgb(250, 230, 250) !important;
            text-align: center;
            transition: transform .2s ease;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            width: 100%;
            max-width: unset;
            border-bottom: 2px solid #eee;
        }

        .theme-card:hover {
            transform: scale(1.03);
        }

        .theme-card h3 {
            font-size: 1.05rem !important;
            margin: 0 0 .5rem !important;
            line-height: 1.2 !important;
            text-align: center !important;
        }

        .theme-card button {
            background-color: #604bb3;
            color: white;
            border: none;
            padding: 8px 12px !important;
            font-size: .95rem !important;
            border-radius: 12px !important;
            cursor: pointer;
            transition: background .3s ease;
            align-self: center !important;
            margin: 0 !important;
        }

        .theme-card button:hover {
            background-color: #983d9d;
        }

        .affirmation-popup {
            position: fixed;
            bottom: 85%;
            left: 50%;
            transform: translateX(-50%);
            background: #ffeef8;
            color: #4a004e;
            padding: 1.5rem 2rem;
            font-size: 2.6rem;
            font-weight: bold;
            border-radius: 1rem;
            box-shadow: 0 8px 20px rgba(0, 0, 0, .2);
            max-width: 90vw;
            width: max-content;
            min-width: 250px;
            word-wrap: break-word;
            white-space: normal;
            text-align: center;
            line-height: 1.5;
            z-index: 9999;
            transition: opacity 1s ease;
            opacity: 1;
        }

        .theme-page .wrap {
            background: #fff;
            border-radius: 16px;
            padding: 12px;
        }

        .toolkit-list {
            display: flex;
            flex-direction: column;
            gap: .5rem;
        }

        .idea-item {
            position: relative;
            padding: .6rem 2.2rem .6rem .9rem;
            border-radius: 12px;
            background: rgba(0, 0, 0, .06);
            border: 1px solid rgba(0, 0, 0, .12);
        }

        .dreamy-box .idea-item {
            background: rgba(255, 255, 255, .14);
            border-color: rgba(255, 255, 255, .26);
            color: #fff;
        }

        .idea-item .idea-del {
            position: absolute;
            right: .4rem;
            top: .4rem;
            border: 0;
            background: transparent;
            cursor: pointer;
            font-size: 1rem;
            line-height: 1;
        }

        .feel-good-content {
            display: none;
        }

        .feel-good-content.open {
            display: block;
        }

        /* ====================== link to delete account ====================== */
        .account-panel {
            margin: 48px auto 18px;
            max-width: 790px;
            background: #8b1919;
            border: 1px solid #eee;
            padding: 14px 16px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, .05);
        }

        .account-panel h3 {
            margin: 0 0 8px;
            font-size: 1.75rem;
            color: white;
            font-size: bolder;
        }

        .account-panel p {
            margin: 0 0 12px;
            color: rgba(152, 152, 207, .758);
            font-weight: bold;
            font-style: italic;
        }

        .account-row {
            display: flex;
            gap: 0px;
            align-items: center;
            flex-wrap: wrap;
        }

        .btn-settings {
            appearance: none;
            border: 0;
            padding: 10px 14px;
            border-radius: 12px;
            background: #111;
            color: #fff;
            font-weight: 700;
            cursor: pointer;
        }

        .h2 {
            color: rgb(124, 124, 145);
        }

        .legal-footer {
            text-align: center;
            font-size: .9rem;
            margin: .5rem 0 6.5rem !important;
            color: var(--text-color) !important;
        }

        .legal-footer a {
            color: inherit;
            text-decoration: underline;
        }

        /* ===== Bottom nav uses your ‚Äúbottom-nav‚Äù class but last item becomes Settings ===== */
        footer.bottom-nav {
            position: fixed;
            left: 0;
            right: 0;
            bottom: 0;
            background: #fff;
            border-top: 1px solid #eee;
            display: flex;
            justify-content: space-around;
            padding: 8px 6px;
            z-index: 50;
        }

        footer.bottom-nav a.nav-icon {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 2px;
            color: #333;
            text-decoration: none;
            font-size: 12px;
        }

        footer.bottom-nav a.nav-icon.active {
            color: #0b5fff;
            font-weight: 800;
        }
    </style>

    <!-- Initialize Firebase for this page (exact path you used) -->
    <script type="module">
        import './firebase-init.js';
    </script>
</head>

<body>
    <main>
        <!-- Page intro -->
        <div class="page-intro">
            <h1>Settings</h1>
            <p class="muted">Manage your account and security. Deletion lives here in the Danger Zone.</p>
        </div>

        <!-- ===== THEME SHOP (moved here, appearance unchanged) ===== -->
        <section class="card theme-size">
            <h2 style="text-align:center">Theme Shop</h2>
            <div id="authControls" style="text-align:center; margin-top:1rem;"></div>

            <div class="theme-gallery">
                <!-- Yellow -->
                <div class="theme-card">
                    <h3>Bingo Yellow</h3><button onclick="setTheme('bingo')">Apply</button>
                </div>
                <div class="theme-card">
                    <h3>Bumblebee Yellow</h3><button onclick="setTheme('bumblebee')">Apply</button>
                </div>
                <div class="theme-card">
                    <h3>Stella Peach</h3><button onclick="setTheme('peach')">Apply</button>
                </div>
                <!-- Red -->
                <div class="theme-card">
                    <h3>Santafe Red</h3><button onclick="setTheme('arcade')">Apply</button>
                </div>
                <!-- Blues -->
                <div class="theme-card">
                    <h3>Dolphin Blue</h3><button onclick="setTheme('dolphin')">Apply</button>
                </div>
                <div class="theme-card">
                    <h3>Moonlight Blue</h3><button onclick="setTheme('moonlight')">Apply</button>
                </div>
                <div class="theme-card">
                    <h3>Brady Blue</h3><button onclick="setTheme('brady')">Apply</button>
                </div>
                <!-- Greens -->
                <div class="theme-card">
                    <h3>JR Green</h3><button onclick="setTheme('green')">Apply</button>
                </div>
                <div class="theme-card">
                    <h3>Monkey Green</h3><button onclick="setTheme('greenmed')">Apply</button>
                </div>
                <div class="theme-card">
                    <h3>Golf Green</h3><button onclick="setTheme('darkgreen')">Apply</button>
                </div>
                <!-- Pinks & Roses -->
                <div class="theme-card">
                    <h3>Strawberry Pink</h3><button onclick="setTheme('strawberry-pink')">Apply</button>
                </div>
                <div class="theme-card">
                    <h3>Shortcake Pink</h3><button onclick="setTheme('shortcake')">Apply</button>
                </div>
                <div class="theme-card">
                    <h3>Prissy Pink</h3><button onclick="setTheme('pinkmed')">Apply</button>
                </div>
                <div class="theme-card">
                    <h3>Date Rose</h3><button onclick="setTheme('rose')">Apply</button>
                </div>
                <!-- Purples -->
                <div class="theme-card">
                    <h3>Starburst Purple</h3><button onclick="setTheme('purple')">Apply</button>
                </div>
                <!-- Brown -->
                <div class="theme-card">
                    <h3>Bubby-Bear Brown</h3><button onclick="setTheme('bubby-bear')">Apply</button>
                </div>
                <!-- Original -->
                <div class="theme-card">
                    <h3>Original Theme</h3><button onclick="setTheme('original')">Reset</button>
                </div>
            </div>

                style="padding-bottom:0; font-size:17px; cursor:pointer; color: var(--accent-color); text-decoration: underline; font-weight:bolder; text-align:center;">
                Each theme is inspired by someone I love.
                <br />Click here to learn more
            </p>

        </section>

        <!-- ===== ACCOUNT (from your settings) ===== -->
        <section class="card account-card">
            <h2>Account</h2>
            <div class="acct-row">
                <div class="acct-left">
                    <div class="acct-email" id="email">‚Äî</div>
                    <div class="acct-sub muted" style="margin-top:6px;">
                        <details>
                            <summary style="cursor:pointer; user-select:none;">Support details</summary>
                            <div style="margin-top:6px;">
                                <div>Sign-in method: <span id="provider">‚Äî</span></div>
                                <div class="row" style="gap:8px; align-items:center;">
                                    <span class="muted">
                                        UID: <code id="uid" style="font-size:12.5px; word-break:break-all;">‚Äî</code>
                                    </span>
                                    <button id="copyUid" type="button">Copy</button>
                                    <span id="copyMsg" class="muted" style="font-size:12px;"></span>
                                </div>
                            </div>
                        </details>
                    </div>
                </div>
                <div class="acct-right">
                    <button id="logoutBtn" class="btn-ghost" type="button">Log out</button>
                </div>
            </div>
        </section>

        <!-- ===== PASSWORD ===== -->
        <section class="card account-card">
            <h2>Password</h2>
            <form id="pwForm" novalidate>
                <input id="pwUser" name="username" type="email" autocomplete="username" tabindex="-1" aria-hidden="true"
                    style="position:absolute;left:-9999px;width:1px;height:1px;opacity:0;border:0;padding:0;margin:0;" />
                <label for="currentPw">Change password (re-auth required)</label>
                <input id="currentPw" type="password" placeholder="Current password" autocomplete="current-password" />
                <input id="newPw" type="password" placeholder="New password (min 6 chars)" autocomplete="new-password"
                    style="margin-top:8px;" />
                <input id="newPw2" type="password" placeholder="Confirm new password" autocomplete="new-password"
                    style="margin-top:8px;" />
                <div class="row" style="margin-top:8px;">
                    <button id="changePw" class="btn" type="submit" disabled>Change password</button>
                </div>
                <div id="pwStatus" class="pw-status" role="status" aria-live="polite"></div>
            </form>
        </section>

        <!-- ===== PREFERENCES / LINKS ===== -->
        <section class="card account-card prefs">
            <a href="theme.html" class="btn-wide">Open theme settings</a>
            <a href="systemSupport.html" class="btn-wide">Open support settings</a>
            <a href="privacy.html" class="btn-wide">Open privacy settings</a>
            <a href="index.html" class="btn-wide">‚Üê Back to app</a>
        </section>

        <!-- ===== DANGER ZONE ===== -->
        <section class="card danger">
            <h2 style="color: red; font-size: 28px;">Danger zone</h2>
            <p class="muted">Permanently delete your account and all data. This action cannot be undone.</p>
            <a href="delete-account.html" style="display:inline-block; margin-top:6px; text-decoration:none;">
                <button class="btn-danger" type="button">Delete account‚Ä¶</button>
            </a>
        </section>
    </main>

    <!-- ===== BOTTOM NAV: Themes ‚Üí Settings ===== -->
    <footer class="bottom-nav">
        <a href="index.html" class="nav-icon">üè†<span>Home</span></a>
        <a href="toolkit-hub.html" class="nav-icon">üß∞<span>Toolkit</span></a>
        <a href="wellness.html" class="nav-icon">üíñ<span>Wellness</span></a>
        <a href="pet.html" class="nav-icon">üêæ<span>Pet</span></a>
        <a href="important-numbers.html" class="nav-icon">üÜò<span>Help</span></a>
        <a href="systemSupport.html" class="nav-icon active" data-auth="true">‚öôÔ∏è<span>Settings</span></a>
    </footer>

    <!-- ========= SCRIPTS ========= -->
    <script type="module">
        /* Keep your imports/logic from both pages, merged safely */
        import { auth, db } from './firebase-init.js';
        import {
            onAuthStateChanged, signOut, EmailAuthProvider,
            reauthenticateWithCredential, updatePassword
        } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        import { doc, setDoc, onSnapshot, getDoc, collection, getDocs, deleteDoc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
        import { Badges } from "./badges.js";

        // ---------- DOM refs (settings/account) ----------
        const emailEl = document.getElementById('email');
        const uidEl = document.getElementById('uid');
        const providerEl = document.getElementById('provider');
        const logoutBtn = document.getElementById('logoutBtn');

        const pwForm = document.getElementById('pwForm');
        const currentPw = document.getElementById('currentPw');
        const newPw = document.getElementById('newPw');
        const newPw2 = document.getElementById('newPw2');
        const changePw = document.getElementById('changePw');
        const pwStatus = document.getElementById('pwStatus');

        const copyBtn = document.getElementById('copyUid');
        const copyMsg = document.getElementById('copyMsg');

        // ---------- DOM refs (theme shop) ----------
        const panel = document.getElementById('accountPanel');
        const acctEmail = document.getElementById('acctEmail');

        // ---------- helpers ----------
        let __pwFlow = false;
        let __stickyErr = null; // { kind:'wrong-current', atValue:'...' }

        function prettyProvider(id) {
            switch (id) {
                case 'password': return 'Email & password';
                case 'google.com': return 'Google';
                case 'apple.com': return 'Apple';
                case 'facebook.com': return 'Facebook';
                case 'github.com': return 'GitHub';
                case 'microsoft.com': return 'Microsoft';
                case 'twitter.com': return 'X (Twitter)';
                case 'yahoo.com': return 'Yahoo';
                case 'phone': return 'Phone number';
                default: return id || 'Unknown';
            }
        }
        function setClick(el, handler) {
            if (!el) return;
            const id = el.id;
            const clone = el.cloneNode(true);
            el.replaceWith(clone);
            clone.addEventListener('click', handler);
            return document.getElementById(id);
        }
        function showStatus() {
            if (!pwStatus) return;
            pwStatus.style.display = 'block';
            pwStatus.setAttribute('role', 'status');
            pwStatus.setAttribute('aria-live', 'polite');
        }
        function setPwMsg(type, msg) {
            if (!pwStatus) return;
            showStatus();
            pwStatus.textContent = msg || '';
            pwStatus.classList.remove('is-error', 'is-ok', 'is-hint');
            pwStatus.classList.add(type === 'ok' ? 'is-ok' : type === 'error' ? 'is-error' : 'is-hint');
        }
        function syncPwUI() {
            if (!currentPw || !newPw || !newPw2 || !changePw) return;
            const cur = currentPw.value, nxt = newPw.value, nxt2 = newPw2.value;
            if (__stickyErr?.kind === 'wrong-current') {
                if (cur === __stickyErr.atValue) {
                    setPwMsg('error', 'Current password is incorrect.'); changePw.disabled = false; return;
                } else { __stickyErr = null; }
            }
            let msg = '';
            if (nxt && nxt.length < 6) msg = 'Password must be at least 6 characters.';
            else if (nxt2 && nxt !== nxt2) msg = 'New passwords do not match.';
            if (msg) setPwMsg('error', msg);
            else if (cur || nxt || nxt2) setPwMsg('hint', '');
            changePw.disabled = !(cur && nxt.length >= 6 && nxt === nxt2);
        }
        async function handlePwSubmit(e) {
            e?.preventDefault?.();
            const user = auth.currentUser;
            if (!user) return;
            const cur = currentPw.value, nxt = newPw.value, nxt2 = newPw2.value;
            if (!cur) { setPwMsg('error', 'Enter your current password.'); return; }
            if (nxt.length < 6) { setPwMsg('error', 'New password must be at least 6 characters.'); return; }
            if (nxt !== nxt2) { setPwMsg('error', 'New passwords do not match.'); return; }
            changePw.disabled = true; setPwMsg('hint', 'Updating‚Ä¶'); __pwFlow = true;
            try {
                const cred = EmailAuthProvider.credential(user.email, cur);
                await reauthenticateWithCredential(user, cred);
                await updatePassword(user, nxt);
                __stickyErr = null; setPwMsg('ok', 'Password updated ‚úÖ');
                currentPw.value = ''; newPw.value = ''; newPw2.value = '';
            } catch (e) {
                const code = e?.code || '';
                if (code === 'auth/invalid-credential' || code === 'auth/wrong-password') {
                    __stickyErr = { kind: 'wrong-current', atValue: cur };
                    setPwMsg('error', 'Current password is incorrect.');
                } else if (code === 'auth/weak-password') {
                    setPwMsg('error', 'New password is too weak.');
                } else if (code === 'auth/requires-recent-login') {
                    setPwMsg('error', 'Please sign in again and retry.');
                } else {
                    setPwMsg('error', 'Could not update password.');
                }
            } finally {
                __pwFlow = false; changePw.disabled = false; syncPwUI();
            }
        }

        // ---------- Theme save / apply (from theme.html) ----------
        const LOCAL_KEY = "lastThemeClass";
        const slug = k => String(k).trim().toLowerCase().replace(/\s+/g, "-");

        function applyThemeClass(themeClass) {
            const root = document.documentElement;
            const next = themeClass || "theme-original";
            const keep = (root.className || "").split(/\s+/).filter(Boolean).filter(c => !c.startsWith("theme-"));
            root.className = [...keep, next].join(" ");
        }

        async function saveTheme(themeKey) {
            const u = auth.currentUser;
            if (!u) { location.replace("login.html?next=settings.html"); return; }
            const cls = `theme-${slug(themeKey)}`;
            applyThemeClass(cls);
            try {
                await setDoc(doc(db, "users", u.uid), { themeClass: cls }, { merge: true });
                localStorage.setItem(LOCAL_KEY, cls);
            } catch (e) {
                console.warn("[theme] setDoc failed, caching locally", e);
                localStorage.setItem(LOCAL_KEY, cls);
            } finally {
                try { await Badges.award("themeChange"); } catch (e) { console.warn("award themeChange:", e); }
            }
        }

        // Keep legacy onclick hooks working
        window.setTheme = saveTheme;
        window.saveTheme = saveTheme;

        // ---------- Auth + hydrate UI ----------
        onAuthStateChanged(auth, (u) => {
            if (!u) {
                if (__pwFlow) return;
                setTimeout(() => (location.href = 'login.html?next=settings.html'), 400);
                return;
            }

            // Account header info
            emailEl && (emailEl.textContent = u.email || '‚Äî');
            uidEl && (uidEl.textContent = u.uid || '‚Äî');
            acctEmail && (acctEmail.textContent = u.email || 'Account');

            if (providerEl) {
                const ids = (u.providerData?.length ? u.providerData.map(p => p.providerId) : [u.providerId]).filter(Boolean);
                providerEl.textContent = ids.map(prettyProvider).join(', ') || 'Email & password';
            }

            const pwUser = document.getElementById('pwUser');
            if (pwUser) pwUser.value = u.email || '';

            // live validation
            if (!pwForm?.dataset.boundInputs) {
                [currentPw, newPw, newPw2].forEach(el => el?.addEventListener('input', syncPwUI));
                pwForm.dataset.boundInputs = '1';
            }
            syncPwUI();

            // logout
            setClick(logoutBtn, async () => {
                if (!logoutBtn) return;
                logoutBtn.disabled = true;
                try { await signOut(auth); location.href = 'index.html'; }
                catch (e) { console.error(e); logoutBtn.disabled = false; alert('Could not log out. Please try again.'); }
            });

            // password submit
            if (!pwForm?.dataset.boundSubmit) {
                pwForm.addEventListener('submit', handlePwSubmit);
                changePw?.addEventListener('click', handlePwSubmit);
                pwForm.dataset.boundSubmit = '1';
            }

            // Theme sync + show account panel
            let first = true;
            const slowTimer = setTimeout(() => {
                if (first && auth.currentUser) {
                    const cached = localStorage.getItem(LOCAL_KEY) || "theme-original";
                    applyThemeClass(cached);
                }
            }, 2000);

            const unsub = onSnapshot(
                doc(db, "users", u.uid),
                (snap) => {
                    clearTimeout(slowTimer);
                    const cls = snap.exists() ? (snap.data().themeClass || "theme-original") : "theme-original";
                    applyThemeClass(cls);
                    localStorage.setItem(LOCAL_KEY, cls);
                    if (first) { panel && (panel.hidden = false); first = false; }
                },
                (err) => {
                    clearTimeout(slowTimer);
                    console.error("[settings/theme] snapshot error:", err);
                    const cached = localStorage.getItem(LOCAL_KEY) || "theme-original";
                    applyThemeClass(cached);
                    panel && (panel.hidden = false);
                }
            );
            // no need to keep unsub reference after leaving page
            window.addEventListener('beforeunload', () => unsub && unsub());
        }, (err) => {
            console.error('[settings] onAuthStateChanged error', err);
            if (!__pwFlow) location.href = 'login.html?next=settings.html';
        });

        // copy UID
        setClick(copyBtn, async () => {
            try {
                await navigator.clipboard.writeText(uidEl?.textContent || '');
                copyBtn.classList.add('copied');
                if (copyMsg) copyMsg.textContent = 'Copied';
                setTimeout(() => { copyBtn.classList.remove('copied'); if (copyMsg) copyMsg.textContent = ''; }, 1200);
            } catch (e) {
                console.error(e); if (copyMsg) copyMsg.textContent = "Couldn't copy";
            }
        });
    </script>
</body>

</html>